name: Rollback Release

on:
  workflow_dispatch:
    inputs:
      action:
        description: "ë¡¤ë°± ìž‘ì—… ì„ íƒ"
        required: true
        type: choice
        options:
          - deprecate
          - unpublish
          - delete-tag
      version:
        description: "ëŒ€ìƒ ë²„ì „ (ì˜ˆ: 1.0.0)"
        required: true
        type: string
      reason:
        description: "ë¡¤ë°± ì‚¬ìœ  (deprecate ì‹œ í•„ìˆ˜)"
        required: false
        type: string

jobs:
  rollback:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Validate inputs
        run: |
          if [[ ! "${{ inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ ìž˜ëª»ëœ ë²„ì „ í˜•ì‹ìž…ë‹ˆë‹¤. ì˜ˆ: 1.0.0"
            exit 1
          fi

          if [[ "${{ inputs.action }}" == "deprecate" && -z "${{ inputs.reason }}" ]]; then
            echo "âŒ deprecate ìž‘ì—…ì—ëŠ” ë¡¤ë°± ì‚¬ìœ ê°€ í•„ìš”í•©ë‹ˆë‹¤."
            exit 1
          fi

      - name: Deprecate npm package
        if: inputs.action == 'deprecate'
        run: |
          VERSION="${{ inputs.version }}"
          REASON="${{ inputs.reason }}"

          echo "ðŸ“¦ íŒ¨í‚¤ì§€ deprecate ì¤‘: daleui@$VERSION"

          # íŒ¨í‚¤ì§€ ì¡´ìž¬ ì—¬ë¶€ í™•ì¸
          if ! npm view daleui@$VERSION version &>/dev/null; then
            echo "âŒ ì˜¤ë¥˜: daleui@$VERSION ë²„ì „ì´ npmì— ì¡´ìž¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
            echo "ì¡´ìž¬í•˜ëŠ” ë²„ì „ì„ í™•ì¸í•˜ì„¸ìš”: npm view daleui versions"
            exit 1
          fi

          # deprecate ì‹¤í–‰ ë° ê²°ê³¼ í™•ì¸
          if npm deprecate daleui@$VERSION "$REASON"; then
            echo "âœ… daleui@$VERSIONì´ deprecated ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤."
            echo "ì‚¬ìš©ìžë“¤ì€ ë‹¤ìŒ ë©”ì‹œì§€ë¥¼ ë³´ê²Œ ë©ë‹ˆë‹¤: $REASON"
          else
            echo "âŒ deprecate ì‹¤íŒ¨. ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”."
            exit 1
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Unpublish npm package
        if: inputs.action == 'unpublish'
        run: |
          VERSION="${{ inputs.version }}"

          echo "âš ï¸ íŒ¨í‚¤ì§€ unpublish ì¤‘: daleui@$VERSION"
          echo "ê²½ê³ : ì´ ìž‘ì—…ì€ ë°°í¬ í›„ 24ì‹œê°„ ì´ë‚´ì—ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."

          # íŒ¨í‚¤ì§€ ì¡´ìž¬ ì—¬ë¶€ í™•ì¸
          if ! npm view daleui@$VERSION version &>/dev/null; then
            echo "âŒ ì˜¤ë¥˜: daleui@$VERSION ë²„ì „ì´ npmì— ì¡´ìž¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
            exit 1
          fi

          # unpublish ì‹¤í–‰ ë° ê²°ê³¼ í™•ì¸
          if npm unpublish daleui@$VERSION; then
            echo "âœ… daleui@$VERSIONì´ npmì—ì„œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤."
          else
            echo "âŒ unpublish ì‹¤íŒ¨. ê°€ëŠ¥í•œ ì›ì¸:"
            echo "  - ë°°í¬ í›„ 24ì‹œê°„ì´ ì§€ë‚¬ì„ ìˆ˜ ìžˆìŠµë‹ˆë‹¤."
            echo "  - ê¶Œí•œì´ ë¶€ì¡±í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤."
            echo "  - ë‹¤ìš´ë¡œë“œê°€ ë§Žì€ íŒ¨í‚¤ì§€ì¼ ìˆ˜ ìžˆìŠµë‹ˆë‹¤."
            echo ""
            echo "ðŸ’¡ ëŒ€ì•ˆ: deprecateë¥¼ ì‚¬ìš©í•˜ì„¸ìš”:"
            echo "   npm deprecate daleui@$VERSION \"This version has been recalled\""
            exit 1
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Delete Git tag
        if: inputs.action == 'delete-tag'
        run: |
          VERSION="${{ inputs.version }}"
          TAG="v$VERSION"

          echo "ðŸ·ï¸ Git íƒœê·¸ ì‚­ì œ ì¤‘: $TAG"

          # Git ì„¤ì •
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # ë¡œì»¬ íƒœê·¸ê°€ ì¡´ìž¬í•˜ëŠ”ì§€ í™•ì¸
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            git tag -d "$TAG"
            echo "ë¡œì»¬ íƒœê·¸ $TAG ì‚­ì œë¨"
          else
            echo "ë¡œì»¬ íƒœê·¸ $TAGê°€ ì¡´ìž¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          fi

          # ì›ê²© íƒœê·¸ ì‚­ì œ
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG"; then
            git push origin :refs/tags/$TAG
            echo "ì›ê²© íƒœê·¸ $TAG ì‚­ì œë¨"
          else
            echo "ì›ê²© íƒœê·¸ $TAGê°€ ì¡´ìž¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          fi

          echo "âœ… Git íƒœê·¸ $TAGê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."

      - name: Create rollback summary
        run: |
          echo "## ðŸ”„ ë¡¤ë°± ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ìž‘ì—…**: ${{ inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ë²„ì „**: ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ inputs.action }}" == "deprecate" ]]; then
            echo "- **ì‚¬ìœ **: ${{ inputs.reason }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ë‹¤ìŒ ë‹¨ê³„" >> $GITHUB_STEP_SUMMARY
            echo "1. ì‚¬ìš©ìžë“¤ì—ê²Œ ê³µì§€ë¥¼ ë³´ë‚´ì„¸ìš”" >> $GITHUB_STEP_SUMMARY
            echo "2. ìˆ˜ì •ëœ ë²„ì „ì„ ë°°í¬í•˜ì„¸ìš”" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ inputs.action }}" == "unpublish" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âš ï¸ ì£¼ì˜ì‚¬í•­" >> $GITHUB_STEP_SUMMARY
            echo "- íŒ¨í‚¤ì§€ê°€ npmì—ì„œ ì™„ì „ížˆ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
            echo "- ì´ë¯¸ ì´ ë²„ì „ì„ ì‚¬ìš© ì¤‘ì¸ ì‚¬ìš©ìžì—ê²Œ ì˜í–¥ì„ ì¤„ ìˆ˜ ìžˆìŠµë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ë‹¤ìŒ ë‹¨ê³„" >> $GITHUB_STEP_SUMMARY
            echo "1. ìˆ˜ì •ëœ ì½”ë“œë¥¼ ì¤€ë¹„í•˜ì„¸ìš”" >> $GITHUB_STEP_SUMMARY
            echo "2. ìƒˆë¡œìš´ ë²„ì „ìœ¼ë¡œ ìž¬ë°°í¬í•˜ì„¸ìš”" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ inputs.action }}" == "delete-tag" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ë‹¤ìŒ ë‹¨ê³„" >> $GITHUB_STEP_SUMMARY
            echo "1. í•„ìš”í•œ ê²½ìš° GitHub Releaseë„ ìˆ˜ë™ìœ¼ë¡œ ì‚­ì œí•˜ì„¸ìš”" >> $GITHUB_STEP_SUMMARY
            echo "2. npm íŒ¨í‚¤ì§€ëŠ” ë³„ë„ë¡œ ì²˜ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "## âŒ ë¡¤ë°± ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ìž‘ì—…**: ${{ inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ë²„ì „**: ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ê°€ëŠ¥í•œ ì›ì¸" >> $GITHUB_STEP_SUMMARY
          echo "- unpublish: 24ì‹œê°„ì´ ì§€ë‚œ ë²„ì „" >> $GITHUB_STEP_SUMMARY
          echo "- ì¡´ìž¬í•˜ì§€ ì•ŠëŠ” ë²„ì „/íƒœê·¸" >> $GITHUB_STEP_SUMMARY
          echo "- NPM_TOKEN ê¶Œí•œ ë¶€ì¡±" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### í•´ê²° ë°©ë²•" >> $GITHUB_STEP_SUMMARY
          echo "- 24ì‹œê°„ì´ ì§€ë‚œ ê²½ìš°: deprecate ì‚¬ìš©" >> $GITHUB_STEP_SUMMARY
          echo "- ìˆ˜ë™ ë¡¤ë°±ì´ í•„ìš”í•œ ê²½ìš°: ë¡œì»¬ì—ì„œ npm CLI ì‚¬ìš©" >> $GITHUB_STEP_SUMMARY
