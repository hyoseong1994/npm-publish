name: Rollback Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "대상 버전 (예: 1.0.0)"
        required: true
        type: string
      reason:
        description: "롤백 사유 (deprecate 시 필수)"
        required: true
        type: string

jobs:
  rollback:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Validate inputs
        run: |
          if [[ ! "${{ inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "❌ 잘못된 버전 형식입니다. 예: 1.0.0"
            exit 1
          fi

          if [[ "${{ inputs.action }}" == "deprecate" && -z "${{ inputs.reason }}" ]]; then
            echo "❌ deprecate 작업에는 롤백 사유가 필요합니다."
            exit 1
          fi

      - name: Get package name
        id: package-info
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "📦 패키지 이름: $PACKAGE_NAME"

      - name: Deprecate npm package
        run: |
          VERSION="${{ inputs.version }}"
          REASON="${{ inputs.reason }}"
          PACKAGE="${{ steps.package-info.outputs.package_name }}"

          echo "📦 패키지 deprecate 중: $PACKAGE@$VERSION"

          # 패키지 존재 여부 확인
          if ! npm view $PACKAGE@$VERSION version &>/dev/null; then
            echo "❌ 오류: $PACKAGE@$VERSION 버전이 npm에 존재하지 않습니다."
            echo "존재하는 버전을 확인하세요: npm view $PACKAGE versions"
            exit 1
          fi

          # deprecate 실행 및 결과 확인
          if npm deprecate $PACKAGE@$VERSION "$REASON"; then
            echo "✅ $PACKAGE@$VERSION이 deprecated 처리되었습니다."
            echo "사용자들은 다음 메시지를 보게 됩니다: $REASON"
          else
            echo "❌ deprecate 실패. 권한을 확인하세요."
            exit 1
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
