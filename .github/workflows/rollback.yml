name: Rollback Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "λ€μƒ λ²„μ „ (μ: 1.0.0)"
        required: true
        type: string
      reason:
        description: "λ΅¤λ°± μ‚¬μ  (deprecate μ‹ ν•„μ)"
        required: true
        type: string

jobs:
  rollback:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Validate inputs
        run: |
          if [[ ! "${{ inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "β μλ»λ λ²„μ „ ν•μ‹μ…λ‹λ‹¤. μ: 1.0.0"
            exit 1
          fi

          if [[ "${{ inputs.action }}" == "deprecate" && -z "${{ inputs.reason }}" ]]; then
            echo "β deprecate μ‘μ—…μ—λ” λ΅¤λ°± μ‚¬μ κ°€ ν•„μ”ν•©λ‹λ‹¤."
            exit 1
          fi

      - name: Get package name
        id: package-info
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "π“¦ ν¨ν‚¤μ§€ μ΄λ¦„: $PACKAGE_NAME"

      - name: Deprecate npm package
        run: |
          VERSION="${{ inputs.version }}"
          REASON="${{ inputs.reason }}"
          PACKAGE="${{ steps.package-info.outputs.package_name }}"

          echo "π“¦ ν¨ν‚¤μ§€ deprecate μ¤‘: $PACKAGE@$VERSION"

          # ν¨ν‚¤μ§€ μ΅΄μ¬ μ—¬λ¶€ ν™•μΈ
          if ! npm view $PACKAGE@$VERSION version &>/dev/null; then
            echo "β μ¤λ¥: $PACKAGE@$VERSION λ²„μ „μ΄ npmμ— μ΅΄μ¬ν•μ§€ μ•μµλ‹λ‹¤."
            echo "μ΅΄μ¬ν•λ” λ²„μ „μ„ ν™•μΈν•μ„Έμ”: npm view $PACKAGE versions"
            exit 1
          fi

          # deprecate μ‹¤ν–‰ λ° κ²°κ³Ό ν™•μΈ
          if npm deprecate $PACKAGE@$VERSION "$REASON"; then
            echo "β… $PACKAGE@$VERSIONμ΄ deprecated μ²λ¦¬λμ—μµλ‹λ‹¤."
            echo "μ‚¬μ©μλ“¤μ€ λ‹¤μ λ©”μ‹μ§€λ¥Ό λ³΄κ² λ©λ‹λ‹¤: $REASON"
          else
            echo "β deprecate μ‹¤ν¨. κ¶ν•μ„ ν™•μΈν•μ„Έμ”."
            exit 1
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
