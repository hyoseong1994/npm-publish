name: Create Release Tag

on:
  pull_request:
    types: [closed]
    branches:
      - main
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 1.0.0)"
        required: true
        type: string

jobs:
  create-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Check if PR is merged from release branch
        id: check-pr
        if: github.event_name == 'pull_request'
        run: |
          PR_BRANCH="${{ github.event.pull_request.head.ref }}"
          IS_MERGED="${{ github.event.pull_request.merged }}"

          if [ "$IS_MERGED" != "true" ]; then
            echo "âŒ PR is not merged, skipping"
            exit 0
          fi

          if [[ ! "$PR_BRANCH" =~ ^release/ ]]; then
            echo "âŒ PR branch is not a release branch: $PR_BRANCH"
            exit 0
          fi

          # Extract version from branch name (release/x.y.z)
          VERSION=$(echo "$PR_BRANCH" | sed 's/^release\///')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Release branch detected: $PR_BRANCH, Version: $VERSION"

      - name: Extract version from input or PR
        id: version-info
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ steps.check-pr.outputs.version }}"
          fi

          if [ -z "$VERSION" ]; then
            echo "âŒ Version not found"
            exit 1
          fi

          # Validate version format
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-(beta|rc|alpha)[0-9]*)?$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            exit 1
          fi

          TAG_NAME="v${VERSION}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: $VERSION, Tag: $TAG_NAME"

      - name: Check if tag already exists
        id: check-tag
        run: |
          TAG_NAME="${{ steps.version-info.outputs.tag_name }}"
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "âœ… Tag $TAG_NAME already exists"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create tag
        if: steps.check-tag.outputs.exists == 'false'
        run: |
          TAG_NAME="${{ steps.version-info.outputs.tag_name }}"
          VERSION="${{ steps.version-info.outputs.version }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create annotated tag
          git tag -a "$TAG_NAME" -m "Release $VERSION"
          git push origin "$TAG_NAME"

          echo "âœ… Tag $TAG_NAME created and pushed"
